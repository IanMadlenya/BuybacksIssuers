############################################################################################ 
#
# SCRUBBING THE DATA
#
# Input: Dataset/X.Rdata generated by merge_dataset.R
#
# scrub removes any remaining data issues only (beyond what was removed in standardize_data.R and in
# merge_dataset.R). In load_data we then remove data based only on "business filters" 
#
#############################################################################################

# Get the usual file where all data is saved at each step:
# global_output_file: see create_dataset.R
load(global_output_file) # always get the data from the previous step, add new data, and save back to it again

events = dataset$SDC
returns_by_event        <- dataset$returns_by_event
returns_by_event_monthly<- dataset$returns_by_event_monthly
ibes                    <- dataset$ibes
compustat_data          <- dataset$compustat_data

## DATA CLEAN-UP
initial_rawdata  = nrow(events)
cleanup$scrub$initial_rawdata <- initial_rawdata

PERMNOS_NA       = is.na(events$permno)
duplicate_events = duplicated(paste(events$X6.CUSIP, " (", events$Event.Date,")",sep="")) # WE SHOULD HAVE AT THIS STAGE! THEY ARE REMOVED IN STANDARDIZE.DATA.R...
No_Closing_Price = is.na(events$Closing.Price) # WE DON'T NEED TO DO THIS HERE, WE CAN CLEAN THIS IN BUSINESS DECISIONS | events$Closing.Price == 0  
No_Event_Size    = is.na(events$Event.Size) # WE DON'T NEED TO DO THIS HERE, WE CAN CLEAN THIS IN BUSINESS DECISIONS | events$Event.Size == 0

cleanup$scrub$PERMNOS_NA       <- sum(PERMNOS_NA)
cleanup$scrub$duplicate_events <- sum(duplicate_events)
cleanup$scrub$No_Closing_Price <- sum(No_Closing_Price)
cleanup$scrub$No_Event_Size    <- sum(No_Event_Size) 

scrub_to_remove = PERMNOS_NA | duplicate_events | No_Closing_Price | No_Event_Size
cleanup$scrub$removed    <- sum(scrub_to_remove) 

if (sum(scrub_to_remove) !=0){
  events                    <- events[!scrub_to_remove,]
  returns_by_event          <- returns_by_event[,!scrub_to_remove]  
  returns_by_event_monthly  <- returns_by_event_monthly[,!scrub_to_remove]  
  for(field in ls(compustat_data))  compustat_data[[field]] <- compustat_data[[field]][!scrub_to_remove]
  for(field in ls(ibes))  ibes[[field]] <- ibes[[field]][!scrub_to_remove]
}

cat(paste("\nThere were: \n",sum(PERMNOS_NA)," with missing PERMNOs\n",sum(duplicate_events)," duplicate events \n",sum(No_Closing_Price)," events with no Closing Price \n",sum(No_Event_Size), " events with 0 Event Size \n",sep=""))
events_after_clean_up <- initial_rawdata - sum(scrub_to_remove)
cleanup$scrub$events_after_clean_up <- events_after_clean_up
cat(paste("After clean up, there are ",events_after_clean_up," events left.\n******\n\n"))

##############################################################################

# END SCRUBBING THE DATA, NOW ADD ROWNAMES AND COLNAMES TO ALL MATRICES
rownames(events)                  <- paste(events$permno, " (", events$Event.Date,")",sep="")
colnames(returns_by_event)        <- paste(events$permno, " (", events$Event.Date,")",sep="")
colnames(returns_by_event_monthly)<- paste(events$permno, " (", events$Event.Date,")",sep="")
SDC = events
events = list()
events$SDC                      <- SDC
events$returns_by_event         <- returns_by_event  
events$returns_by_event_monthly <- returns_by_event_monthly
events$compustat_data           <- compustat_data
events$ibes                     <- ibes
# Finally now add this in the events list
events$cleanup = cleanup
save(events,file=global_output_file)
